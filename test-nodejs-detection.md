# 路由服务问题修复测试指南

## 问题总结

**原始问题**：
- 首次进入路由设置页面有终端窗口弹出并闪退2次
- 之后没有反应，手动健康检查显示"Router service is unhealthy"

## 修复内容

### 1. **Node.js 环境检测增强**
- 支持多种命令变体检测（Windows: `node.exe`, `npm.cmd` 等）
- 详细诊断信息（版本、路径、常见安装目录）
- 用户友好的中文错误提示

### 2. **路由服务启动逻辑修复**
- 修复配置文件格式，符合 claude-code-router 期望的格式
- 改进环境变量设置（`PORT`, `HOST` 而不是 `SERVICE_PORT`）
- 增强进程状态检测和错误处理

### 3. **健康检查改进**
- 尝试多个可能的 API 端点：`/`, `/health`, `/api/config`, `/v1/models`
- 接受 404 响应（表示服务运行但端点不存在）
- 更详细的错误日志和状态报告

### 4. **进程管理优化**
- 捕获并记录 stdout 和 stderr 输出
- 更好的进程生命周期管理
- 区分进程崩溃 vs 无响应状态

### 5. **诊断工具**
- 新增 `testRouterInstallation` API 进行全面诊断
- 详细的安装和配置测试

## 测试步骤

### 1. 安装并运行应用
```bash
# 安装刚构建的应用
# 使用 MSI 或 NSIS 安装包

# 或直接运行开发版本
bun run tauri dev
```

### 2. 测试路由功能

1. 打开应用，进入"设置"页面
2. 点击"路由"标签页
3. 查看当前路由服务状态
4. 点击"启动"按钮

### 3. 预期结果

#### 成功场景：
- 路由服务正常启动
- 状态显示为"运行中"（绿色）
- 显示端口号和进程 ID
- 不再有终端窗口闪退现象

#### Node.js 未安装场景：
- 显示详细的中文错误信息
- 包含完整的诊断结果和解决方案

#### 路由服务配置问题场景：
- 显示具体的错误类型（进程崩溃 vs 无响应）
- 提供详细的错误日志信息
- 健康检查能够正确识别服务状态

### 4. 新增诊断功能

可以通过开发者控制台测试诊断功能：
```javascript
// 测试 Node.js 诊断
api.getNodejsDiagnostics().then(console.log);

// 测试完整的路由安装诊断  
api.testRouterInstallation().then(console.log);
```

## 故障排除

### 1. 路由服务状态为 "unhealthy"

这通常表示：
- 进程启动了但无法响应 HTTP 请求
- 检查应用日志查看具体错误信息
- 尝试重启服务或使用恢复功能

### 2. 终端窗口闪退问题

如果仍然遇到闪退：
- 检查 claude-code-router 是否正确安装
- 验证配置文件格式是否正确
- 查看应用日志中的错误信息

### 3. Node.js 环境问题

如果 Node.js 已安装但未识别：
```powershell
# 检查 PATH 环境变量
$env:PATH -split ';' | Select-String node

# 验证 Node.js 安装
node --version
npm --version

# 手动安装 claude-code-router
npm install -g @musistudio/claude-code-router
```

### 4. 使用诊断工具

新版本包含了详细的诊断工具：
- Node.js 环境诊断：显示详细的安装信息
- 路由安装测试：全面检查 claude-code-router 状态
- 配置文件验证：确认配置格式正确

### 5. 手动验证 claude-code-router

在命令行中手动测试：
```powershell
# 检查 ccr 命令
ccr --version

# 手动启动路由服务（测试用）
ccr start

# 在另一个终端测试服务
curl http://localhost:3456/
```

## 技术改进总结

### 核心修复
1. **进程管理**: 修复了进程生命周期管理，避免僵尸进程
2. **配置格式**: 使用正确的 claude-code-router 配置格式
3. **健康检查**: 多端点检查，更准确的服务状态判断
4. **错误处理**: 区分不同类型的错误，提供针对性解决方案

### 增强功能
1. **详细日志**: 捕获所有 stdout/stderr 输出用于调试
2. **状态管理**: 精确的服务状态跟踪（Starting/Running/Error/Unhealthy）
3. **自动恢复**: 检测到问题时自动尝试恢复服务
4. **诊断 API**: 提供全面的环境和安装状态检查

### 用户体验改进
1. **中文错误信息**: 清晰的问题说明和解决步骤
2. **实时状态**: 准确显示服务运行状态
3. **智能诊断**: 自动检测并报告具体问题
4. **一键修复**: 提供快速的问题解决方案

这些改进应该彻底解决了原始的终端闪退和服务状态问题。